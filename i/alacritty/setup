#!/bin/zsh
set -eux -o pipefail

# currently not in any repository, installing from git
# NOTE snap has a version that is _not_ from the author
# from https://github.com/alacritty/alacritty
# install instructions might change (eg, dependencies change sometimes)

(
    cd ${0:a:h}/alacritty

    # NOTE paths are set already in i/zsh/path.zsh for rustup
    # TODO we might never update rustup?
    which rustup || (curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh)
    rustup override set stable
    rustup update stable

    dependencies=(
        cmake
        pkg-config
        libfreetype6-dev
        libfontconfig1-dev
        libxcb-xfixes0-dev
        libxkbcommon-dev
        python3
        libegl1-mesa-dev  # only needed for wayland with nvidia gpu for EGL drivers
    )
    sudo apt-get install -y $dependencies

    cargo build --release
    infocmp alacritty || (echo 'no alacritty terminfo'; exit 1)
    cp --force target/release/alacritty ~/bin
)

# TODO could also install zsh completion for alacritty
# see https://github.com/alacritty/alacritty/blob/master/INSTALL.md#zsh

# TODO the config file is copied from the template in ./alacritty/alacritty.yaml
# sometimes check the diff to see if new features are there
ln -sfT ${0:a:h}/alacritty.yml ~/.alacritty.yml
# NOTE we cant execute the above 'ln' while pwd is the submodule
# because ${0:a:h} will resolve to that folder and we link
# the template yaml file instead
