#!/bin/zsh
set -eux -o pipefail

# setup workspace for flow (nn + an additional PATH entry)
# name by first argument or current folder

base=${1:-.}
base=${base:a}
name=$(realpath --relative-base=$HOME $base)

envs=(
    -e workspace_active=yes
    -e workspace_home=$base
    -e h=$base
    -e PATH=$HOME/config/bin/nn/flow:$HOME/config/bin/nn:$base/bin:$base/.venv/bin:$PATH
    -e VIRTUAL_ENV=$base/.venv
    -e PYTHONPATH=$base/python
    -e build_flow=yes  # for the bin/build script
)

cmds=(
    new-session -s $name -A -c $base $envs true \;
    bind-key V new-window -n src -c $base -bt 1 V \;
    bind-key j new-window -n jobs x jobs ls -r \;
    new-window -n src V
)

tmux $cmds
