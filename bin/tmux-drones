#!/bin/zsh
set -eux -o pipefail

# setup workspace for drones

base=~/toys/drones

envs=(
    # TODO not sure about the -E option, should we have it or not?
    -e workspace_active=yes
    -e workspace_home=$base
    -e h=$base
    # TODO ever any problem when the venv is not there yet?
    -e PATH=$base/bin:$base/.venv/bin:$PATH
    -e VIRTUAL_ENV=$base/.venv
    -e PYTHONPATH=$base/python
)
# TODO are there more workspace_* settings we can use?

# NOTE the initial command does not respect PATH (not sure if a bug)
# all subsequent commands respect -e PATH=...
# the initial command respects only PATH from the calling environment
# plus sets this as the global tmux environment when it's the first session that also starts the server
# we dont want that, so we make the first command a no-op

cmds=(
    new-session -s drones -A -c $base $envs true \;
    bind-key V new-window -n src -c $base -bt 1 V \;
    new-window -n src V
)

tmux $cmds
