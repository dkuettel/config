#!/bin/zsh
set -eux -o pipefail

if [[ ! -d /efs ]]; then
    sudo mkdir -p /efs
    sudo chown dkuettel:dkuettel /efs
fi

if mountpoint /efs; then
    echo 'something is already mounted at /efs' >&2
    exit 1
fi

# maybe check https://serverfault.com/questions/6709/sshfs-mount-that-survives-disconnect
# todo testing reconnect, will it work after sleep/suspend?
# todo auto_cache working for hemanths big rendering files?

case $(hostname) in
    (boom)
        # NOTE direct ip is much faster, aws ssm is only meant for admin ssh, not for data
        sshfs -o allow_root,reconnect -o auto_cache efs@00.000.000.00:/efs /efs
        ;;
    (base)
        sshfs -o allow_root,reconnect -o auto_cache efs:/efs /efs
        ;;
    (*)
        echo "unknown local host $(hostname)" >&2
        exit 1
        ;;
esac

# alternative
# sshfs -o auto_cache,reconnect -o Ciphers=aes128-ctr -o Compression=no -o allow_other efs:/efs /efs
