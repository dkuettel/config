#!/bin/zsh
set -eu -o pipefail

source ${0:a:h}/include/pre.zsh

while [[ $# != 0 ]]; do
    arg=$1; shift
    case $arg in

        (root)
            args+=(--user 0:0)
            cmd=(bash)
            ;;

        (bash)
            cmd=(bash)
            # TODO zsh is installed, but need to take care of configuration, just map in?
            # probably map in only here, not always
            ;;

        (ipython)
            cmd=(ipython3)
            ;;

        (train)
            # TODO with-log could be a log arg here and then it's generic, but also make cmd+=() or set flag?
            cmd=(
                # with-log docker.log
                python3
                -m nn.mtar360.eap1 train
                    mt360vis
                    --config-folder=s3://e2e-benchmarking/training/zurich-all-set/recolored
                    #--config-folder=s3://e2e-benchmarking/training/zurich-all-set/recolored-full360
                    #--config-folder=s3://e2e-benchmarking/training/Ender3DPrinter
                    --assembly=ktm.Right
                    #--assembly=continental.viewpoint_0000
                    #--assembly=ferrari_488_red.viewpoint_0000
                    #--assembly=Ender3DPrinter.viewpoint_0000
                    --out-folder=.
                    --short-training
                    # --update-template batchnorm_convergence.num_batches 10
                    --variable-length-training
                    # --sample-count-multiplier=2
                    # --gpu-count=4
                    # --update-template training.batch_recycling '{"shuffle_buffer_size": 10, "repeat_count": 2}'
                    # --integration-test
                    # --fp16-quantization
                    #--testsets=mtar360/all/recolored/v2
            )
            ;;

        (integration-test)
            # NOTE this is roughly how cristi runs it, but with a different config.json
            cmd=(
                #with-log docker.log
                python3
                -m nn.mtar360.eap1 train
                    --config-folder=s3://e2e-benchmarking/training/zurich-all-set/recolored
                    --out-folder=.
                    --assemblies=ktm.Right
                    --gpu-count=1
                    --variable-length-training
                    --integration-test
                    --centroid-pooling
                    --fp16-quantization
                    mt360vis
                )
            ;;

        (viewer)
            cmd=(
                #python3
                python3 ~/toys/vtrace/vtrace.py run
                -m nn.rendering.viewer
                trainset
                s3://e2e-benchmarking/training/AssemblyStates/lego-lighthouse-31051/all-shaded
                #s3://e2e-benchmarking/training/AssemblyStates/delonghi-coffee-machine/all-recolored
            )
            ;;

        (render-video)
            cmd=(
                #python3
                python3 ~/toys/vtrace/vtrace.py run
                -m nn.mtar360.utils.render_video
                augmented
                --testset=mtar360/all/recolored/v2:ktm.Right
                --frame-period=10
                --output-fps=10
                --config-path=s3://e2e-benchmarking/training/zurich-all-set/recolored
                --mt360=/efs/jaeschbacher/xps/full360/short/zh_recolored/ktm.Right/0/export/recalibrated_model
                --draw-edges=gt,red
                --draw-edges=pred,blue
                --draw-label
                --draw-refpoints
                --output-path=./video.mp4
            )
            ;;

        (pytest)
            # NOTE can also run on kubernetes using 'x start pytest ...'
            if [[ $# == 0 ]]; then
                cmd=(
                    # this is what CI runs
                    pytest -svv -m 'not slow'
                )
            else
                cmd=(
                    # NOTE arg 1 can look like 'mtar360/test_train_eval_runs.py::test_train_eval[mt360-style1]'
                    # that's what you get at the end of a summary for failed tests
                    pytest -svv $1
                )
                shift
            fi
            args+=(--workdir=/xp/src/nn/tests)
            ;;

        (pytest-slow)
            cmd=(
                pytest -svv
            )
            ;;

        (*)
            echo 'unknown value:' $arg
            exit 1
            ;;

    esac
done

source ${0:a:h}/include/post.zsh
