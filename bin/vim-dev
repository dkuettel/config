#!/bin/zsh -eu
set -o pipefail
# use to run vim in a dev folder
# it assumes $dev is set and moves to that folder
# (usually containing src/nn src/caffe and the like)
# it updates the tags file, and exits with vim

# todo can we then also have the .tags file be anonymous and not polluting the working folder?
# todo use sponge as in private project
# todo use pid file for every call
# todo clean up when exiting

cd $dev

tags () {
    exec > >(ts > .tags.log-$$)
    exec 2>&1
    tagsfile=.tags.generating-$$ # $$=pid, in case we run more than one in the same folder
    while true; do
        ctags \
            -o $tagsfile \
            --languages=python \
            --links=no \
            --fields=+K \
            --fields=+m \
            --extra=+q \
            --totals=yes \
            -R \
                src/nn/python \
                src/nn/tests
        # note ctags also supports --exclude, currently I explicitely add folders that I want python tags for
        # note --extra=q includes class-qualified entries, but not for python :/, but for c++
        # todo once I work again with caffe, add lang=c and caffe part? can we mix languages?
        mv $tagsfile .tags
        sleep 20
    done
}

cat > .ctrlp.find << 'eof'
#!/bin/zsh
set -eu -o pipefail

find \
    src/nn/python \
    src/nn/tests \
    \( \
        -name '*.py' \
        -or -name '*.txt' \
        -or -name '*.sh' \
        -or -name '*.yaml' \
    \)

find \
    src/nn/docker \
    src/nn/bin \
    src/nn/setup
eof
chmod +x .ctrlp.find

echo using =ctags
tags &
vim $@
kill %tags
wait
