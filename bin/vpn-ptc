#!/bin/zsh
set -eu -o pipefail

# run the script with sudo or as root
# it asks the ptc password only once
# then it connects
# you can disconnect with ctrl-c
# and later hit enter to reconnect
# (with the same password)

echo 'ptc password:'
read -s pass

while true; do
	echo 'connect'
	(stoken; echo $pass) | openconnect \
		--timestamp \
		--juniper emea-portal.ptc.com \
		--user=dkuettel \
		--passwd-on-stdin || true
	# order of passwords:
	# - possibly sudo
	# - current token
	# - ptc password
	echo 'disconnected'
	echo 'hit enter to reconnect'
	read
done
